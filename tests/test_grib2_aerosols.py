import pytest
import numpy as np
import grib2io

test_file = "tests/input_data/gefs.chem.t00z.a2d_0p25.f000.grib2_subset"


section4_eval = {'totAsy340': np.array([    0,    48,    20,   104, 62000,     0,     6,    20,     0,
            0,     7,     9,   338,     9,   342,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totSSA340': np.array([    0,    48,    20,   103, 62000,     0,     6,    20,     0,
            0,     7,     9,   338,     9,   342,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD440': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9,   430,     9,   450,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD550': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totScatAOD550': np.array([    0,    48,    20,   112, 62000,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'duAOD550': np.array([    0,    48,    20,   102, 62001,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'duScatAOD550': np.array([    0,    48,    20,   112, 62001,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'ssAOD550': np.array([    0,    48,    20,   102, 62008,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'ssScatAOD550': np.array([    0,    48,    20,   112, 62008,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'so4AOD550': np.array([    0,    48,    20,   102, 62006,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'so4ScatAOD550': np.array([    0,    48,    20,   112, 62006,     0,     8,    70,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'omAOD550': np.array([    0,    48,    20,   102, 62010,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'omScatAOD550': np.array([    0,    48,    20,   112, 62010,     0,     8,    70,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'bcAOD550': np.array([    0,    48,    20,   102, 62009,     0,     6,    20,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'bcScatAOD550': np.array([    0,    48,    20,   112, 62009,     0,     8,    70,     0,
            0,     7,     9,   545,     9,   565,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD645': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9,   620,     9,   670,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD870': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9,   841,     9,   876,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD1640': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9,  1628,     9,  1652,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'totAOD11100': np.array([    0,    48,    20,   102, 62000,     0,     6,    20,     0,
            0,     7,     9, 11000,     9, 11200,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'sfc_du_pm25': np.array([    0,    48,    13,   193, 62001,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,     1,     0,     0,   255,     0,
            0]),
 'sfc_du_pm10': np.array([    0,    48,    13,   192, 62001,     0,     6,    10,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,     1,     0,     0,   255,     0,
            0]),
 'sfc_ss_pm25': np.array([    0,    48,    13,   193, 62008,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,     1,     0,     0,   255,     0,
            0]),
 'sfc_tot_pm10': np.array([    0,    48,    13,   192, 62000,     0,     6,    10,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,     1,     0,     0,   255,     0,
            0]),
 'sfc_tot_pm25': np.array([    0,    48,    13,   193, 62000,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,     1,     0,     0,   255,     0,
            0]),
 'tot_pm10_colmd': np.array([    0,    48,    20,     1, 62000,     0,     6,    10,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'tot_pm25_colmd': np.array([    0,    48,    20,     1, 62000,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'du_pm25_colmd': np.array([    0,    48,    20,     1, 62001,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'ss_pm25_colmd': np.array([    0,    48,    20,     1, 62008,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'bc_pm236_colmd': np.array([    0,    48,    20,     1, 62009,     0,    10,   236,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'om_pm424_colmd': np.array([    0,    48,    20,     1, 62010,     0,    10,   424,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0]),
 'so4_pm25_colmd': np.array([    0,    48,    20,     1, 62006,     0,     7,    25,     0,
            0,   255,     0,     0,     0,     0,     2,     0,    96,
            0,     0,     1,     0,    10,     0,     0,   255,     0,
            0])}

test_dict = {'totAsy340': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 338,
  'scaledValueOfSecondWavelength': 342,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Asymmetry Factor at 338-342nm'},
 'totSSA340': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 338,
  'scaledValueOfSecondWavelength': 342,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Single Scattering Albedo at 338-342nm'},
 'totAOD440': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 430,
  'scaledValueOfSecondWavelength': 450,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 430-450nm'},
 'totAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 545-565nm'},
 'totScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Scattering Aerosol Optical Thickness'},
 'duAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62001,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Dust Dry Aerosol Optical Thickness at 545-565nm'},
 'duScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62001,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Dust Dry Scattering Aerosol Optical Thickness'},
 'ssAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62008,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Sea Salt Dry Aerosol Optical Thickness at 545-565nm'},
 'ssScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62008,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Sea Salt Dry Scattering Aerosol Optical Thickness'},
 'so4AOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62006,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Sulphate Dry Aerosol Optical Thickness at 545-565nm'},
 'so4ScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 70,
  'typeOfAerosol': 62006,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Sulphate Dry Scattering Aerosol Optical Thickness'},
 'omAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62010,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Particulate Organic Matter Dry Aerosol Optical Thickness at 545-565nm'},
 'omScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 70,
  'typeOfAerosol': 62010,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Particulate Organic Matter Dry Scattering Aerosol Optical Thickness'},
 'bcAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62009,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Black Carbon Dry Aerosol Optical Thickness at 545-565nm'},
 'bcScatAOD550': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 545,
  'scaledValueOfSecondWavelength': 565,
  'scaledValueOfFirstSize': 70,
  'typeOfAerosol': 62009,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Black Carbon Dry Scattering Aerosol Optical Thickness'},
 'totAOD645': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 620,
  'scaledValueOfSecondWavelength': 670,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 620-670nm'},
 'totAOD870': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 841,
  'scaledValueOfSecondWavelength': 876,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 841-876nm'},
 'totAOD1640': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 1628,
  'scaledValueOfSecondWavelength': 1652,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 1628-1652nm'},
 'totAOD11100': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 11000,
  'scaledValueOfSecondWavelength': 11200,
  'scaledValueOfFirstSize': 20,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'Numeric',
  'fullName': 'Total Aerosol Optical Thickness at 11000-11200nm'},
 'sfc_du_pm25': {'typeOfFirstFixedSurface': 1,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62001,
  'parameterCategory': 13,
  'units': 'µg m-3',
  'fullName': 'Dust Dry Particulate matter (fine)'},
 'sfc_du_pm10': {'typeOfFirstFixedSurface': 1,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 10,
  'typeOfAerosol': 62001,
  'parameterCategory': 13,
  'units': 'µg m-3',
  'fullName': 'Dust Dry Particulate matter (coarse)'},
 'sfc_ss_pm25': {'typeOfFirstFixedSurface': 1,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62008,
  'parameterCategory': 13,
  'units': 'µg m-3',
  'fullName': 'Sea Salt Dry Particulate matter (fine)'},
 'sfc_tot_pm10': {'typeOfFirstFixedSurface': 1,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 10,
  'typeOfAerosol': 62000,
  'parameterCategory': 13,
  'units': 'µg m-3',
  'fullName': 'Total Aerosol Particulate matter (coarse)'},
 'sfc_tot_pm25': {'typeOfFirstFixedSurface': 1,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62000,
  'parameterCategory': 13,
  'units': 'µg m-3',
  'fullName': 'Total Aerosol Particulate matter (fine)'},
 'tot_pm10_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 10,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Total Aerosol Column-Integrated Mass Density'},
 'tot_pm25_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62000,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Total Aerosol Column-Integrated Mass Density'},
 'du_pm25_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62001,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Dust Dry Column-Integrated Mass Density'},
 'ss_pm25_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62008,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Sea Salt Dry Column-Integrated Mass Density'},
 'bc_pm236_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 236,
  'typeOfAerosol': 62009,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Black Carbon Dry Column-Integrated Mass Density'},
 'om_pm424_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 424,
  'typeOfAerosol': 62010,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Particulate Organic Matter Dry Column-Integrated Mass Density'},
 'so4_pm25_colmd': {'typeOfFirstFixedSurface': 10,
  'scaledValueOfFirstWavelength': 0,
  'scaledValueOfSecondWavelength': 0,
  'scaledValueOfFirstSize': 25,
  'typeOfAerosol': 62006,
  'parameterCategory': 20,
  'units': 'kg m-2',
  'fullName': 'Sulphate Dry Column-Integrated Mass Density'}}
@pytest.fixture
def grib_file():
    grb = grib2io.open(test_file)
    yield grb
    grb.close()

def test_variables(grib_file):
    """Test AOD variables at different wavelengths"""

    grib_file = grib2io.open(test_file)

    testkeys = [k for k in test_dict.keys()]

    for index,k in enumerate(testkeys):
        print(k)
        msg = grib_file.select(shortName=k)[0]
        np.testing.assert_array_equal(section4_eval[k], msg.section4)
        assert msg.scaledValueOfFirstWavelength == test_dict[k]['scaledValueOfFirstWavelength']
        assert msg.scaledValueOfSecondWavelength == test_dict[k]['scaledValueOfSecondWavelength']

        assert msg.typeOfFirstFixedSurface.value == test_dict[k]['typeOfFirstFixedSurface']
        assert msg.typeOfAerosol == test_dict[k]['typeOfAerosol']
        assert msg._isAerosol == True
        assert msg.parameterCategory == test_dict[k]['parameterCategory']
        assert msg.units == test_dict[k]['units']
        assert msg.fullName == test_dict[k]['fullName']
